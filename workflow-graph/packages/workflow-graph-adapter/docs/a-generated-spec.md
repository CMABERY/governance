# Workflow Graph: A-Style Product Spec (spec generator layer)

This is a concrete instantiation of the **Version Control Design Template (A)** for a workflow-builder graph domain.

---

## 1) Git-to-domain concept map

| Git concept | Workflow Graph equivalent |
|---|---|
| Repository | Workflow project (collection of graphs + metadata) |
| Working tree | Current canvas state (nodes/edges/config) |
| Atom | Node (`node:<id>`) or edge (`edge:<id>`) |
| Diff | Canvas overlay + inspector panel deltas |
| Stage / index | Frozen patch overlay over a base (`from_hash`) |
| Commit | **Checkpoint** (named state snapshot) |
| Branch | Lane (parallel evolution line) |
| Merge | Reconcile session (auto merge + conflicts + resolutions) |
| Reflog | Recovery trail for destructive actions |

---

## 2) Minimal command protocol (local)

Commands are illustrative; wire format can vary as long as invariants hold.

### `status`
Returns:
- current head checkpoint id
- staged entries (count + summary)
- dirty summary (added/removed/modified node/edge counts)

### `stage`
Input:
- list of atom selectors to stage OR a patch payload
Rules:
- staging must record `from_hash` of the base state used for diffing
- staging must not chase later edits

### `checkpoint`
Input:
- message, author
Output:
- new checkpoint id + state hash

### `diff`
Modes:
- working vs head
- staged vs head
- checkpoint A vs checkpoint B
Output:
- domain diff ops + domain rendering hints

### `restore`
Modes:
- restore atom(s)
- reset to checkpoint
Rules:
- destructive restores create reflog entries

---

## 3) Data model (kernel vs domain)

Kernel-owned:
- checkpoints (state hash + parent refs + metadata)
- refs (lanes/branches)
- reflog entries
- index/staging overlay (patch ops referencing `from_hash`)
- reconcile sessions (merge attempts, conflicts, resolutions)

Adapter-owned (domain meaning):
- canonical graph representation (nodes/edges)
- diff ops and render hints
- merge semantics and conflict taxonomy
- validation rules + localized issues

---

## 4) Domain-native diff rendering strategy

Primary rendering channel: the graph canvas.

- Added node: green glow + “+” badge
- Removed node: ghosted outline + “–” badge
- Modified node: highlight + inspector diff
- Added edge: highlighted stroke
- Removed edge: dashed ghost
- Modified edge: label highlight

Secondary channel:
- a textual summary (counts + notable atom selectors)
- an optional JSON view for power users

---

## 5) Collaboration + remote (“GitHub for workflows”)

Remote objects:
- published lanes/branches
- pull requests (PRs) with:
  - checkpoint range
  - canvas diff preview
  - validation status (gating)
  - conflict forecast (optional)

Protections:
- require validation green for protected lane
- require review for high-risk changes (adapter risk classification hook)

---

## 6) MVP + v2 plan

### MVP
- Local checkpoints + restore
- Staging overlay with `from_hash`
- Domain diff overlays on the canvas
- Deterministic 3-way merge + conflicts list
- Validation with localized issues
- Reflog-style recovery for destructive actions

### v2
- PR review UI + inline comments pinned to `node:<id>` / `edge:<id>`
- Risk-based protections (auto gate merges)
- Conflict resolution UI (choose resolution actions, revalidate)
- Sync/remote publishing and collaboration

---

## 7) Explicit assumptions

- Node IDs and edge IDs are stable identities generated by the builder, not derived from array position.
- Edges are directed; graphs are intended to be DAGs (cycles are invalid).
- Canonicalization forbids floats in persisted objects; any UI coordinates are quantized before persistence.
